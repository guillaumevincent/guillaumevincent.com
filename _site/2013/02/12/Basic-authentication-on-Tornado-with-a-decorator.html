<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="fr"><!--<![endif]-->

<head>
    <meta charset="utf-8">
    <title>Basic authentication on Tornado with a decorator</title>
    <meta name="viewport" content="width=device-width" />
    <title>Site personnel de Guillaume Vincent</title>

    <link rel="stylesheet" href="/css/normalize.css" />
    <link rel="stylesheet" href="/css/foundation.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/pygments.css" />
    <script src="/js/custom.modernizr.js"></script>

</head>
<body>

  <nav style="" class="top-bar">
    <ul class="title-area">
      <!-- Title Area -->
      <li class="name">
        <h1><a href="/">Guillaume <span class="orange">Vincent</span></a></h1>
    </li>
    <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
    <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
</ul>


<section class="top-bar-section">
  <!-- Right Nav Section -->
  <ul class="right">
    <li class="divider"></li>
    <li class="has-form">
      <a href="/" class="button alert">Blog</a>
  </li>
  <li class="divider"></li>
  <li class="has-form">
      <a href="https://github.com/guillaumevincent/" class="button success">Code</a>
  </li>
  <li class="divider"></li>
  <li class="has-form">
      <a href="/contact.html" class="button">A propos</a>
  </li>
  <li class="divider"></li>
  <li class="has-form">
      <a href="http://okiwi.org/" class="button okiwi">Okiwi</a>
  </li>
  <li class="divider"></li>
    <li class="has-form">
      <a href="http://guillaumevincent.com/feed.xml" class="button rss">RSS</a>
  </li>
</ul>
</section>
</nav>

<script src="/js/jquery-1.9.0.min.js"></script>


<div class="row">
	<div class="large-9 columns post-title"><h1>Basic authentication on Tornado with a decorator</h1> </div>
	<div class="large-3 columns post-date"> 12 Feb 2013 </div>
</div>


<div class="row">
	<div class="large-12 columns post-content">
		<p>
<a href='http://www.tornadoweb.org/'>Tornado</a> is an open source web server developed by Facebook. It implement various third-party authentication schemes to connect to services like Facebook, Google OAuth, Twitter, etc. But Tornado doesn't provide a good documentation when you try to handle your own login service. I tried to do mine. Let's take a look:
<br />
I recently tried to make <a href='/2013/02/09/Basic-authentication-on-Tornado.html'>my own authentication</a> method in my application with Tornado. And I remained frustrated because I do not happen to use decorators. Decorator are evaluated before the function definition is executed. You remove duplication when you have to protect differents handlers. 
<br />
My goal is to allow a user to access my web application when he has good permissions. I add 3 handlers, one for my index (MainHandler), one for my login page (AuthLoginHandler), one for my logout page (AuthLogoutHandler). 
</p><div class='highlight'><pre><code class='python'><span class='k'>class</span> <span class='nc'>Application</span><span class='p'>(</span><span class='n'>tornado</span><span class='o'>.</span><span class='n'>web</span><span class='o'>.</span><span class='n'>Application</span><span class='p'>):</span>
    <span class='k'>def</span> <span class='nf'>__init__</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='n'>handlers</span> <span class='o'>=</span> <span class='p'>[</span>
            <span class='p'>(</span><span class='s'>r&quot;/&quot;</span><span class='p'>,</span> <span class='n'>MainHandler</span><span class='p'>),</span>
            <span class='p'>(</span><span class='s'>r&quot;/auth/login/&quot;</span><span class='p'>,</span> <span class='n'>AuthLoginHandler</span><span class='p'>),</span>
            <span class='p'>(</span><span class='s'>r&quot;/auth/logout/&quot;</span><span class='p'>,</span> <span class='n'>AuthLogoutHandler</span><span class='p'>),</span>
        <span class='p'>]</span>
        <span class='n'>settings</span> <span class='o'>=</span> <span class='p'>{</span>
            <span class='s'>&quot;template_path&quot;</span><span class='p'>:</span><span class='n'>Settings</span><span class='o'>.</span><span class='n'>TEMPLATE_PATH</span><span class='p'>,</span>
            <span class='s'>&quot;static_path&quot;</span><span class='p'>:</span><span class='n'>Settings</span><span class='o'>.</span><span class='n'>STATIC_PATH</span><span class='p'>,</span>
            <span class='s'>&quot;debug&quot;</span><span class='p'>:</span><span class='n'>Settings</span><span class='o'>.</span><span class='n'>DEBUG</span><span class='p'>,</span>
            <span class='s'>&quot;cookie_secret&quot;</span><span class='p'>:</span> <span class='n'>Settings</span><span class='o'>.</span><span class='n'>COOKIE_SECRET</span><span class='p'>,</span>
            <span class='s'>&quot;login_url&quot;</span><span class='p'>:</span> <span class='s'>&quot;/auth/login/&quot;</span>
        <span class='p'>}</span>
        <span class='n'>tornado</span><span class='o'>.</span><span class='n'>web</span><span class='o'>.</span><span class='n'>Application</span><span class='o'>.</span><span class='n'>__init__</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>handlers</span><span class='p'>,</span> <span class='o'>**</span><span class='n'>settings</span><span class='p'>)</span>
</code></pre>
</div>
<p>The settings[&#8220;login_url&#8221;] property set the url to be used by the @authenticated decorator. What I want is to redirect the user to login url (/auth/login/) if he&#8217;s not identified.</p>
<div class='highlight'><pre><code class='python'><span class='k'>class</span> <span class='nc'>MainHandler</span><span class='p'>(</span><span class='n'>BaseHandler</span><span class='p'>):</span>
    <span class='nd'>@tornado.web.authenticated</span>
    <span class='k'>def</span> <span class='nf'>get</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='n'>username</span> <span class='o'>=</span> <span class='n'>tornado</span><span class='o'>.</span><span class='n'>escape</span><span class='o'>.</span><span class='n'>xhtml_escape</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>current_user</span><span class='p'>)</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>write</span><span class='p'>(</span><span class='s'>&quot;index.html&quot;</span><span class='p'>,</span> <span class='n'>username</span> <span class='o'>=</span> <span class='n'>username</span><span class='p'>)</span>
</code></pre>
</div>
<p>It&#8217;s so simple, isn&#8217;t it ? <br /> It remains for me to create a handler for my login screen, and a handler to delete my cookie when i reach auth/logout/ url.</p>
<div class='highlight'><pre><code class='python'><span class='k'>class</span> <span class='nc'>AuthLoginHandler</span><span class='p'>(</span><span class='n'>BaseHandler</span><span class='p'>):</span>
    <span class='k'>def</span> <span class='nf'>get</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='k'>try</span><span class='p'>:</span>
            <span class='n'>errormessage</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>get_argument</span><span class='p'>(</span><span class='s'>&quot;error&quot;</span><span class='p'>)</span>
        <span class='k'>except</span><span class='p'>:</span>
            <span class='n'>errormessage</span> <span class='o'>=</span> <span class='s'>&quot;&quot;</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>render</span><span class='p'>(</span><span class='s'>&quot;login.html&quot;</span><span class='p'>,</span> <span class='n'>errormessage</span> <span class='o'>=</span> <span class='n'>errormessage</span><span class='p'>)</span>

    <span class='o'>...</span>

<span class='k'>class</span> <span class='nc'>AuthLogoutHandler</span><span class='p'>(</span><span class='n'>BaseHandler</span><span class='p'>):</span>
    <span class='k'>def</span> <span class='nf'>get</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>clear_cookie</span><span class='p'>(</span><span class='s'>&quot;user&quot;</span><span class='p'>)</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>redirect</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>get_argument</span><span class='p'>(</span><span class='s'>&quot;next&quot;</span><span class='p'>,</span> <span class='s'>&quot;/&quot;</span><span class='p'>))</span>
</code></pre>
</div>
<p>My login handler get method render the login.html page.</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;form</span> <span class='na'>action=</span><span class='s'>&quot;/auth/login/&quot;</span> <span class='na'>method=</span><span class='s'>&quot;post&quot;</span> <span class='na'>id=</span><span class='s'>&quot;login_form&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;fieldset&gt;</span>
        <span class='nt'>&lt;label</span> <span class='na'>for=</span><span class='s'>&quot;username&quot;</span><span class='nt'>&gt;</span>Username<span class='nt'>&lt;/label&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>class=</span><span class='s'>&quot;text-input&quot;</span> <span class='na'>id=</span><span class='s'>&quot;username&quot;</span> <span class='na'>name=</span><span class='s'>&quot;username&quot;</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>value=</span><span class='s'>&quot;&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;/fieldset&gt;</span>

    <span class='nt'>&lt;fieldset&gt;</span>
        <span class='nt'>&lt;label</span> <span class='na'>for=</span><span class='s'>&quot;password&quot;</span><span class='nt'>&gt;</span>Password<span class='nt'>&lt;/label&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>class=</span><span class='s'>&quot;text-input&quot;</span> <span class='na'>id=</span><span class='s'>&quot;password&quot;</span> <span class='na'>name=</span><span class='s'>&quot;password&quot;</span> <span class='na'>type=</span><span class='s'>&quot;password&quot;</span> <span class='na'>value=</span><span class='s'>&quot;&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;/fieldset&gt;</span>

    <span class='nt'>&lt;fieldset&gt;</span>
        <span class='nt'>&lt;span</span> <span class='na'>class=</span><span class='s'>&quot;errormessage&quot;</span><span class='nt'>&gt;&lt;/span&gt;</span>
    <span class='nt'>&lt;/fieldset&gt;</span>

    <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;form_btn&quot;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>id=</span><span class='s'>&quot;signin-btn&quot;</span> <span class='na'>class=</span><span class='s'>&quot;btn btn-blue&quot;</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>value=</span><span class='s'>&quot;Sign In&quot;</span> <span class='na'>tabindex=</span><span class='s'>&quot;3&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;/div&gt;</span>
<span class='nt'>&lt;/form&gt;</span>
</code></pre>
</div><center><img src='https://lh5.googleusercontent.com/-nfy2GESHMmI/URYyQCgy_4I/AAAAAAAAK7U/FA33XlBrjto/s299/login.png' /></center>
<p>When a user makes a POST request on /auth/login/, my web server validates if the pair username/password is good and writes the user cookie. Otherwise it redirects the user to the login page with an error message.</p>
<div class='highlight'><pre><code class='python'><span class='k'>class</span> <span class='nc'>AuthLoginHandler</span><span class='p'>(</span><span class='n'>BaseHandler</span><span class='p'>):</span>
    <span class='k'>def</span> <span class='nf'>get</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='k'>try</span><span class='p'>:</span>
            <span class='n'>errormessage</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>get_argument</span><span class='p'>(</span><span class='s'>&quot;error&quot;</span><span class='p'>)</span>
        <span class='k'>except</span><span class='p'>:</span>
            <span class='n'>errormessage</span> <span class='o'>=</span> <span class='s'>&quot;&quot;</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>render</span><span class='p'>(</span><span class='s'>&quot;login.html&quot;</span><span class='p'>,</span> <span class='n'>errormessage</span> <span class='o'>=</span> <span class='n'>errormessage</span><span class='p'>)</span>

    <span class='k'>def</span> <span class='nf'>check_permission</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>password</span><span class='p'>,</span> <span class='n'>username</span><span class='p'>):</span>
        <span class='k'>if</span> <span class='n'>username</span> <span class='o'>==</span> <span class='s'>&quot;admin&quot;</span> <span class='ow'>and</span> <span class='n'>password</span> <span class='o'>==</span> <span class='s'>&quot;admin&quot;</span><span class='p'>:</span>
            <span class='k'>return</span> <span class='bp'>True</span>
        <span class='k'>return</span> <span class='bp'>False</span>

    <span class='k'>def</span> <span class='nf'>post</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>):</span>
        <span class='n'>username</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>get_argument</span><span class='p'>(</span><span class='s'>&quot;username&quot;</span><span class='p'>,</span> <span class='s'>&quot;&quot;</span><span class='p'>)</span>
        <span class='n'>password</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>get_argument</span><span class='p'>(</span><span class='s'>&quot;password&quot;</span><span class='p'>,</span> <span class='s'>&quot;&quot;</span><span class='p'>)</span>
        <span class='n'>auth</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>check_permission</span><span class='p'>(</span><span class='n'>password</span><span class='p'>,</span> <span class='n'>username</span><span class='p'>)</span>
        <span class='k'>if</span> <span class='n'>auth</span><span class='p'>:</span>
            <span class='bp'>self</span><span class='o'>.</span><span class='n'>set_current_user</span><span class='p'>(</span><span class='n'>username</span><span class='p'>)</span>
            <span class='bp'>self</span><span class='o'>.</span><span class='n'>redirect</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>get_argument</span><span class='p'>(</span><span class='s'>&quot;next&quot;</span><span class='p'>,</span> <span class='s'>u&quot;/&quot;</span><span class='p'>))</span>
        <span class='k'>else</span><span class='p'>:</span>
            <span class='n'>error_msg</span> <span class='o'>=</span> <span class='s'>u&quot;?error=&quot;</span> <span class='o'>+</span> <span class='n'>tornado</span><span class='o'>.</span><span class='n'>escape</span><span class='o'>.</span><span class='n'>url_escape</span><span class='p'>(</span><span class='s'>&quot;Login incorrect&quot;</span><span class='p'>)</span>
            <span class='bp'>self</span><span class='o'>.</span><span class='n'>redirect</span><span class='p'>(</span><span class='s'>u&quot;/auth/login/&quot;</span> <span class='o'>+</span> <span class='n'>error_msg</span><span class='p'>)</span>

    <span class='k'>def</span> <span class='nf'>set_current_user</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>user</span><span class='p'>):</span>
        <span class='k'>if</span> <span class='n'>user</span><span class='p'>:</span>
            <span class='bp'>self</span><span class='o'>.</span><span class='n'>set_secure_cookie</span><span class='p'>(</span><span class='s'>&quot;user&quot;</span><span class='p'>,</span> <span class='n'>tornado</span><span class='o'>.</span><span class='n'>escape</span><span class='o'>.</span><span class='n'>json_encode</span><span class='p'>(</span><span class='n'>user</span><span class='p'>))</span>
        <span class='k'>else</span><span class='p'>:</span>
            <span class='bp'>self</span><span class='o'>.</span><span class='n'>clear_cookie</span><span class='p'>(</span><span class='s'>&quot;user&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>All the current user informations are saved in a secure cookie. Tornado provide set_secure_cookie and get_secure_cookie methods. These two methods use a cookie secret key to encrypt the cookie.</p>

<p>Hope this helped !</p>
<a href='https://gist.github.com/guillaumevincent/4771570'>See the gist associate</a>
	</div>
</div>
<div class="row">
	<hr/>
	<div class="large-12 columns">
		<ul id="social_icon">
			<li id="panel1"><a id="twitter" href="" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=600');return false;"></a></li>
			<li id="panel2"><a id="googleplus" href="" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=600');return false;"></a></li>
			<li id="panel3"><a id="facebook" href="" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=600');return false;"></a></li>
		</ul>
		<a href="#top" class="top" alt="Back to top"></a>
	</div>
</div>
<script>
$(document).ready(function() {
	var pathname = encodeURI(window.location);
	var tweeturl = 'http://twitter.com/share?url=' + pathname + '&text=Basic authentication on Tornado with a decorator&via=rolalagile';
	$("#twitter").attr("href", tweeturl);

	var googleplusurl = 'https://plus.google.com/share?url=' + pathname
	$("#googleplus").attr("href", googleplusurl);

	var facebookurl = 'http://www.facebook.com/share.php?u=' + pathname
	$("#facebook").attr("href", facebookurl);
});
</script>
<div class="row">

	<div id="disqus_thread" class="large-12 columns"></div>
</div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'guillaumevincent'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
    	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
	Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>








<!-- google analytics -->
<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-34916388-1']);
_gaq.push(['_setDomainName', 'guillaumevincent.com']);
_gaq.push(['_trackPageview']);

(function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>

<script src="/js/foundation.min.js"></script>
  <!--
  
  <script src="js/foundation/foundation.js"></script>
  
  <script src="js/foundation/foundation.alerts.js"></script>
  
  <script src="js/foundation/foundation.clearing.js"></script>
  
  <script src="js/foundation/foundation.cookie.js"></script>
  
  <script src="js/foundation/foundation.dropdown.js"></script>
  
  <script src="js/foundation/foundation.forms.js"></script>
  
  <script src="js/foundation/foundation.joyride.js"></script>
  
  <script src="js/foundation/foundation.magellan.js"></script>
  
  <script src="js/foundation/foundation.orbit.js"></script>
  
  <script src="js/foundation/foundation.placeholder.js"></script>
  
  <script src="js/foundation/foundation.reveal.js"></script>
  
  <script src="js/foundation/foundation.section.js"></script>
  
  <script src="js/foundation/foundation.tooltips.js"></script>
  
  <script src="js/foundation/foundation.topbar.js"></script>
  
-->

<script>
$(document).foundation();
</script>
</body>
</html>
